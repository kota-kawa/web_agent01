# Browser Operation Agent - Data Supply Stack

## æ¦‚è¦ (Overview)

æœ¬å®Ÿè£…ã¯ã€LLMãŒã‚¦ã‚§ãƒ–ã‚’æ­£ç¢ºã«æ“ä½œã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸã€Œãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘ã‘ãƒ‡ãƒ¼ã‚¿ä¾›çµ¦ã‚¹ã‚¿ãƒƒã‚¯ã€ã§ã™ã€‚è»½é‡ãƒ»å®‰å®šãƒ»å†ç¾æ€§ã®é«˜ã„DOM/è¦–è¦šæƒ…å ±ã®æä¾›ã‚’é€šã˜ã¦ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹ã‚¦ã‚§ãƒ–è‡ªå‹•åŒ–ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## å®Ÿè£…å†…å®¹ (Implementation)

### âœ… å®Œäº†ã—ãŸæ©Ÿèƒ½

#### 1. 4ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

**IDX-Text v1 (ç´¢å¼•ä»˜ããƒ†ã‚­ã‚¹ãƒˆ)**
- äººé–“ãŒèª­ã¿ã‚„ã™ã„ç´¢å¼•å½¢å¼ã§ã®DOMè¡¨ç¾
- å®‰å®šå‚ç…§IDä»˜ãã®index_map
- æ®µéšå–å¾—ãƒ»å·®åˆ†æ›´æ–°å¯¾å¿œ

**AX-Slim v1 (ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æŠœç²‹)**
- æ“ä½œå¯¾è±¡ä¸­å¿ƒã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æƒ…å ±
- CDPã®Accessibilityãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨
- role/name/value/visibleã®æ˜ç¢ºãªæƒ…å ±

**DOM-Lite v1 (æœ€å°é™ã®éšå±¤JSON)**
- æ©Ÿæ¢°å‡¦ç†å‘ã‘ã®çµ±ä¸€ã‚­ãƒ¼æ§‹é€ 
- bboxãƒ»clickableç­‰ã®æ“ä½œæƒ…å ±
- ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆå±æ€§ã®ã¿ä¿æŒ

**VIS-ROI v1 (ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ + OCR)**
- Page.captureScreenshotã«ã‚ˆã‚‹ç”»åƒå–å¾—
- pytesseractã«ã‚ˆã‚‹OCRå‡¦ç†
- DOMãƒªãƒ³ã‚¯ä»˜ããƒ†ã‚­ã‚¹ãƒˆèªè­˜

#### 2. å®‰å®šå‚ç…§ã‚·ã‚¹ãƒ†ãƒ 

**å‚ç…§IDå½¢å¼**
```
F0:BN-812345  (frameId + backendNodeId)
F1:AX-123     (frameId + axNodeId)
```

**ç‰¹å¾´**
- iframe/Shadow DOMå¯¾å¿œã®frameåˆ†é›¢
- CDPç”±æ¥ã®å®‰å®šã—ãŸãƒãƒ¼ãƒ‰ID
- å‘¼ã³å‡ºã—é–“ã§ã®ä¸€è²«æ€§ä¿è¨¼

#### 3. LLM I/Oå¥‘ç´„ (Action DSL)

**ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**
```json
{
  "type": "act",
  "actions": [
    {"op": "click", "target": "F0:BN-812346"},
    {"op": "type", "target": "F0:BN-812345", "text": "ãƒãƒ¼ãƒˆPC"},
    {"op": "scroll", "direction": "down", "amount": 800}
  ]
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ—**
- `plan`: ç¾åœ¨çŠ¶æ…‹ã®å–å¾—
- `act`: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- `ask`: è³ªå•ãƒ»ç¢ºèª
- `retry`: çŠ¶æ…‹å†å–å¾—

#### 4. æœ€é©åŒ–æ©Ÿèƒ½

**æ®µéšå–å¾—**
- åˆå›: viewport/ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å‘¨è¾ºã®ã¿
- å¿…è¦æ™‚: è¿½åŠ å–å¾—

**å·®åˆ†å†é€**
- å‰å›ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ã®æ¯”è¼ƒ
- å¤‰æ›´ç‚¹ã®ã¿å†é€ä¿¡

**ãƒˆãƒ¼ã‚¯ãƒ³æœ€é©åŒ–**
- æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°è¨ˆç®—
- å¯è¦–/æ“ä½œå¯èƒ½ãƒ•ã‚£ãƒ«ã‚¿

#### 5. ãƒ­ã‚°ãƒ»çµ±è¨ˆ

**æŠ½å‡ºçµ±è¨ˆ**
- nodes_sent: é€ä¿¡ãƒãƒ¼ãƒ‰æ•°
- tokens_estimated: æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°
- diff_bytes: å·®åˆ†ãƒã‚¤ãƒˆæ•°
- extraction_time_ms: æŠ½å‡ºæ™‚é–“

**æ“ä½œçµ±è¨ˆ**
- click_success_rate: ã‚¯ãƒªãƒƒã‚¯æˆåŠŸç‡
- retry_count: ãƒªãƒˆãƒ©ã‚¤å›æ•°
- not_found_rate: è¦ç´ æœªç™ºè¦‹ç‡

#### 6. E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

**æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ç³»**
- å…¥åŠ›â†’æ¤œç´¢â†’çµæœä¸€è¦§
- å•†å“é¸æŠâ†’ã‚«ãƒ¼ãƒˆè¿½åŠ 

**ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ç³»**
- Readability.jsã«ã‚ˆã‚‹æœ¬æ–‡æŠ½å‡º
- ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‘—è€…ãƒ»æœ¬æ–‡ã®æ§‹é€ åŒ–

**ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç³»**
- ã‚¿ãƒ–åˆ‡æ›¿ãƒ»ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é¸æŠ
- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
BrowserOperationAgent
â”œâ”€â”€ DataSupplyStack (CDP + Playwright)
â”‚   â”œâ”€â”€ IDX-TextæŠ½å‡º
â”‚   â”œâ”€â”€ AX-SlimæŠ½å‡º  
â”‚   â”œâ”€â”€ DOM-LiteæŠ½å‡º
â”‚   â””â”€â”€ VIS-ROIæŠ½å‡º
â”œâ”€â”€ ActionProcessor (LLM Command Handler)
â”‚   â”œâ”€â”€ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ è¦ç´ è§£æ±º
â”‚   â””â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
â””â”€â”€ Metrics & Logging
```

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
agent/browser/
â”œâ”€â”€ data_supply_stack.py    # ä¸»è¦ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¨ãƒ³ã‚¸ãƒ³
â”œâ”€â”€ action_processor.py     # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³DSLå‡¦ç†
â”œâ”€â”€ browser_agent.py        # çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
â””â”€â”€ dom.py                  # æ—¢å­˜DOMå‡¦ç† (Playwright)

tests/
â”œâ”€â”€ test_data_supply_stack.py   # å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
â””â”€â”€ test_e2e_acceptance.py      # E2Eå—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ

demo.py                     # ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹

```python
from agent.browser.browser_agent import BrowserOperationAgent

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–
agent = BrowserOperationAgent()
await agent.initialize()

# ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ãƒˆ
result = await agent.navigate("https://example.com")

# ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
data = await agent.extract_page_data()

# LLMã‚³ãƒãƒ³ãƒ‰å‡¦ç†
command = {
    "type": "act",
    "actions": [
        {"op": "type", "target": "F0:BN-812345", "text": "æ¤œç´¢èª"},
        {"op": "click", "target": "F0:BN-812346"}
    ]
}
result = await agent.process_llm_command(json.dumps(command))

await agent.close()
```

### ç‰¹åŒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

```python
# æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ å‘ã‘
search_agent = await create_search_form_agent()

# ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹å‘ã‘
article_agent = await create_article_reading_agent()

# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å‘ã‘
dashboard_agent = await create_dashboard_agent()
```

## å—ã‘å…¥ã‚Œæ¡ä»¶

### âœ… é”æˆæ¸ˆã¿

1. **4ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”Ÿæˆ**: IDX-Text, AX-Slim, DOM-Lite, VIS-ROI
2. **å®‰å®šå‚ç…§ã‚·ã‚¹ãƒ†ãƒ **: frameId + backendNodeId/AXNodeId
3. **LLM I/Oå¥‘ç´„**: JSON Action DSL
4. **å·®åˆ†ãƒ»æ®µéšå–å¾—**: å®Ÿè£…æ¸ˆã¿
5. **ãƒ­ã‚°ãƒ»çµ±è¨ˆ**: åŒ…æ‹¬çš„ãƒ¡ãƒˆãƒªã‚¯ã‚¹
6. **3ã‚µã‚¤ãƒˆå¯¾å¿œ**: æ¤œç´¢ãƒ»è¨˜äº‹ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### ğŸ“Š æ€§èƒ½ç›®æ¨™

- **ãƒªãƒˆãƒ©ã‚¤ç‡**: â‰¤ 1.0% (ç›®æ¨™)
- **æœªç™ºè¦‹ç‡**: â‰¤ 2.0% (ç›®æ¨™)  
- **æˆåŠŸç‡**: â‰¥ 90% (ç›®æ¨™)
- **3å›é€£ç¶šæˆåŠŸ**: E2Eãƒ†ã‚¹ãƒˆã§æ¤œè¨¼

## ä¾å­˜é–¢ä¿‚

### Python ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
```
playwright>=1.55.0      # ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–
pychrome>=0.2.4         # CDPæ¥ç¶š
readabilipy>=0.3.0      # æœ¬æ–‡æŠ½å‡º
pytesseract>=0.3.13     # OCRå‡¦ç†
pillow>=11.3.0          # ç”»åƒå‡¦ç†
pytest>=8.4.2           # ãƒ†ã‚¹ãƒˆ
pytest-asyncio>=1.2.0   # éåŒæœŸãƒ†ã‚¹ãƒˆ
```

### ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
- Chrome/Chromium (CDPå¯¾å¿œ)
- Tesseract OCR (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å˜ä½“ãƒ†ã‚¹ãƒˆ
python -m pytest tests/test_data_supply_stack.py -v

# E2Eå—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ (è¦ãƒ–ãƒ©ã‚¦ã‚¶)
python -m pytest tests/test_e2e_acceptance.py -m integration -v

# ãƒ‡ãƒ¢å®Ÿè¡Œ
python demo.py
```

## è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³

```python
config = BrowserAgentConfig(
    debug_port=9222,           # CDP ãƒãƒ¼ãƒˆ
    headless=True,             # ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰
    viewport_width=1400,       # ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¹…
    viewport_height=900,       # ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜
    staged_extraction=True,    # æ®µéšå–å¾—
    enable_ocr=True,          # OCRæœ‰åŠ¹
    enable_readability=True,   # Readabilityæœ‰åŠ¹
    max_retry_attempts=3       # æœ€å¤§ãƒªãƒˆãƒ©ã‚¤
)
```

## æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

1. **è¿½åŠ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: è¦ä»¶ã«å¿œã˜ã¦æ–°å½¢å¼è¿½åŠ 
2. **OCRã‚¨ãƒ³ã‚¸ãƒ³**: Tesseractä»¥å¤–ã®ã‚¨ãƒ³ã‚¸ãƒ³å¯¾å¿œ
3. **ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ³ã‚¸ãƒ³**: Firefox, Safariå¯¾å¿œ
4. **åˆ†æ•£å‡¦ç†**: è¤‡æ•°ãƒ–ãƒ©ã‚¦ã‚¶ä¸¦åˆ—å‡¦ç†
5. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: æŠ½å‡ºçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

## è²¢çŒ®

ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€issueå ±å‘Šã€æ©Ÿèƒ½ææ¡ˆã‚’æ­“è¿ã—ã¾ã™ã€‚

---

**å®Ÿè£…è€…**: AI Programming Assistant  
**å®Ÿè£…æ—¥**: 2025å¹´9æœˆ13æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0