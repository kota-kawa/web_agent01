services:
  vnc:
    build: 
      context: .           # ← ルートをコンテキストに
      dockerfile: vnc/Dockerfile
    ports:
      - "6901:6901"     # noVNC
      - "9222:9222"     # Chrome DevTools
      - "7000:7000"     # Playwright API
    networks: [small_browser_net]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/healthz"]
      interval: 5s
      timeout: 2s
      retries: 12
    volumes:
      - .:/app
    environment:
      # Show Yahoo Japan only on the first browser launch
      - START_URL=https://www.yahoo.co.jp/

  web:
    build: ./web
    working_dir: /app/web
    command: python -u app.py
    environment:
      - PYTHONPATH=/app
      # Ensure front-end matches initial Yahoo start page
      - START_URL=https://www.yahoo.co.jp/
      # Configure the live browser iframe (noVNC). Override NOVNC_PORT when the
      # service is published on a different host port, or use NOVNC_URL to point
      # at an externally reachable endpoint when running behind a proxy.
      - NOVNC_PORT=6901
      # - NOVNC_URL=https://example.com/novnc/
    env_file:
      - .env
    ports:
      - "5000:5000"
    volumes:
      - .:/app
    depends_on:
      vnc:
        condition: service_healthy
    networks: [small_browser_net]

networks:
  small_browser_net:
    driver: bridge
